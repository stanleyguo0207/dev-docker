LLVM build
---

### llvm-project编译手册

此文章写于 **llvm-project** `13.0.1` 版本。之后版本未必适用，可查看链接。

#### 参考链接

https://llvm.org/docs/CMake.html

### 最终编译脚本

```shell
cmake \
    -Hllvm \
    -BRelease \
    -GNinja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=/opt/llvm-toolset/ \
    -DCMAKE_C_COMPILER=/opt/rh/gcc-toolset-11/root/usr/bin/gcc \
    -DCMAKE_CXX_COMPILER=/opt/rh/gcc-toolset-11/root/usr/bin/g++ \
    -DCMAKE_CXX_LINK_FLAGS="-Wl,-rpath,/opt/rh/gcc-toolset-11/root/usr/lib64 -L/opt/rh/gcc-toolset-11/root/usr/lib64" \
    -DCMAKE_CXX_STANDARD=17 \
    -DBUILD_SHARED_LIBS=ON \
    -DLLVM_BUILD_32_BITS=OFF \
    -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld;lldb" \
    -DLLVM_TARGETS_TO_BUILD=X86 \
    -DLLVM_ENABLE_WARNINGS=OFF
    # -DLLVM_ENABLE_RUNTIMES="compiler-rt;libc;libcxx;libcxxabi;libunwind" \

cmake --build Release --parallel
cmake --install Release
```

### 文档解读

#### CMake 变量

**用不到的字段没有解析。**

-   `CMAKE_BUILD_TYPE:STRING`

    要编译的类型，直接用`Release `就好了。

-   `CMAKE_INSTALL_PREFIX:PATH`

    LLVM 的安装路径。

-   `CMAKE_{C,CXX}_FLAGS:STRING`

    `C`和`C++`源文件的构建标志。

-   `CMAKE_{C,CXX}_COMPILER:STRING`

    `C`和`C++`编译器指定。

-   `CMAKE_CXX_STANDARD:STRING`

    构建 LLVM 的 c++ 标准。默认为14。可以14、17、20。

-   `CMAKE_INSTALL_BINDIR:PATH`

    安装可执行的路径。默认"bin"。

-   `CMAKE_INSTALL_INCLUDEDIR:PATH`

    安装头文件的路径。默认"include"。

-   `CMAKE_INSTALL_DOCDIR:PATH`

    安装文档的路径。默认"share/doc"。

-   `CMAKE_INSTALL_MANDIR:PATH`

    安装man文档的路径。默认"share/man"。


#### LLVM 变量

-   `LLVM_ENABLE_PROJECTS:STRING`

    控制启动项目。 "clang;clang-tools-extra;cross-project-tests;libc;libclc;lld;lldb;openmp;polly;pstl"

-   `LLVM_ENABLE_RUNTIMES:STRING`

    控制运行库。"compiler-rt;libc;libcxx;libcxxabi;libunwind;openmp"

-   `LLVM_LIBDIR_SUFFIX:STRING`

    安装库目录额外后缀。可以使用 `-DLLVM_LIBDIR_SUFFIX=64` 将库安装到 `/usr/lib64`。

-   `LLVM_PARALLEL_{COMPILE,LINK}_JOBS:STRING`

    并行度内存限制。`-GNinja -DLLVM_PARALLEL_LINK_JOBS=2`。

-   `LLVM_TARGETS_TO_BUILD:STRING`

    控制哪些目标。 `-DLLVM_TARGETS_TO_BUILD=X86`。

-   `LLVM_USE_LINKER:STRING`

    覆盖默认的链接器。`-DLLVM_USE_LINKER=lld`。

-   `BUILD_SHARED_LIBS:BOOL`

    LLVM 的组件是否使用共享库。`BUILD_SHARED_LIBS` 仅建议 LLVM 开发人员使用。 如果要将 LLVM 构建为共享库，则应使用 `LLVM_BUILD_LLVM_DYLIB` 选项。

-   `LLVM_ABI_BREAKING_CHECKS:STRING`

    是否应该使用 ABI 中断构建 LLVM 。`WITH_ASSERTS`（默认）、`FORCE_ON` 和 `FORCE_OFF`。

-   `LLVM_UNREACHABLE_OPTIMIZE:BOOL`
-   `LLVM_APPEND_VC_REV:BOOL`
-   `LLVM_BUILD_32_BITS:BOOL`

    是否构建32位的可执行文件和库。64位系统应该关闭。`-DLLVM_BUILD_32_BITS=OFF`。

-   `LLVM_BUILD_BENCHMARKS:BOOL`
-   `LLVM_BUILD_DOCS:BOOL`
-   `LLVM_BUILD_EXAMPLES:BOOL`
-   `LLVM_BUILD_INSTRUMENTED_COVERAGE:BOOL`
-   `LLVM_CODE_COVERAGE_TARGETS:STRING`
-   `LLVM_COVERAGE_SOURCE_DIRS:STRING`
-   `LLVM_BUILD_LLVM_DYLIB:BOOL`
-   `LLVM_BUILD_TESTS:BOOL`
-   `LLVM_BUILD_TOOLS:BOOL`
-   `LLVM_CCACHE_BUILD:BOOL`
-   `LLVM_CREATE_XCODE_TOOLCHAIN:BOOL`
-   `LLVM_DEFAULT_TARGET_TRIPLE:STRING`
-   `LLVM_DOXYGEN_QCH_FILENAME:STRING`
-   `LLVM_DOXYGEN_QHELPGENERATOR_PATH:STRING`
-   `LLVM_DOXYGEN_QHP_CUST_FILTER_NAME:STRING`
-   `LLVM_DOXYGEN_QHP_NAMESPACE:STRING`
-   `LLVM_DOXYGEN_SVG:BOOL`
-   `LLVM_ENABLE_ASSERTIONS:BOOL`
-   `LLVM_ENABLE_BINDINGS:BOOL`
-   `LLVM_ENABLE_DIA_SDK:BOOL`
-   `LLVM_ENABLE_DOXYGEN:BOOL`
-   `LLVM_ENABLE_DOXYGEN_QT_HELP:BOOL`
-   `LLVM_ENABLE_EH:BOOL`
-   `LLVM_ENABLE_EXPENSIVE_CHECKS:BOOL`
-   `LLVM_ENABLE_FFI:BOOL`
-   `LLVM_ENABLE_IDE:BOOL`
-   `LLVM_ENABLE_LIBCXX:BOOL`

    如果主机编译器和链接器支持 stdlib 标志，则将 stdlib=libc++ 传递给两者，避免使用 stdlibc++。默认是关闭的

-   `LLVM_ENABLE_LIBPFM:BOOL`
-   `LLVM_ENABLE_LLD:BOOL`
-   `LLVM_ENABLE_LTO:STRING`
-   `LLVM_ENABLE_MODULES:BOOL`
-   `LLVM_ENABLE_PEDANTIC:BOOL`
-   `LLVM_ENABLE_PIC:BOOL`
-   `LLVM_ENABLE_PROJECTS:STRING`
-   `LLVM_ENABLE_RUNTIMES:STRING`
-   `LLVM_ENABLE_RTTI:BOOL`
-   `LLVM_ENABLE_SPHINX:BOOL`
-   `LLVM_ENABLE_THREADS:BOOL`
-   `LLVM_ENABLE_UNWIND_TABLES:BOOL`
-   `LLVM_ENABLE_WARNINGS:BOOL`
-   `LLVM_ENABLE_WERROR:BOOL`
-   `LLVM_ENABLE_Z3_SOLVER:BOOL`
-   `LLVM_ENABLE_ZLIB:BOOL`
-   `LLVM_EXPERIMENTAL_TARGETS_TO_BUILD:STRING`
-   `LLVM_EXTERNAL_{CLANG,LLD,POLLY}_SOURCE_DIR:PATH`
-   `LLVM_EXTERNAL_PROJECTS:STRING`
-   `LLVM_EXTERNALIZE_DEBUGINFO:BOOL`
-   `LLVM_FORCE_USE_OLD_TOOLCHAIN:BOOL`
-   `LLVM_INCLUDE_BENCHMARKS:BOOL`
-   `LLVM_INCLUDE_EXAMPLES:BOOL`
-   `LLVM_INCLUDE_TESTS:BOOL`
-   `LLVM_INCLUDE_TOOLS:BOOL`
-   `LLVM_INSTALL_BINUTILS_SYMLINKS:BOOL`
-   `LLVM_INSTALL_CCTOOLS_SYMLINKS:BOOL`
-   `LLVM_INSTALL_OCAMLDOC_HTML_DIR:STRING`
-   `LLVM_INSTALL_SPHINX_HTML_DIR:STRING`
-   `LLVM_INSTALL_UTILS:BOOL`
-   `LLVM_INTEGRATED_CRT_ALLOC:PATH`
-   `LLVM_INSTALL_DOXYGEN_HTML_DIR:STRING`
-   `LLVM_LINK_LLVM_DYLIB:BOOL`
-   `LLVM_LIT_ARGS:STRING`
-   `LLVM_LIT_TOOLS_DIR:PATH`
-   `LLVM_OPTIMIZED_TABLEGEN:BOOL`
-   `LLVM_PARALLEL_COMPILE_JOBS:STRING`
-   `LLVM_PARALLEL_LINK_JOBS:STRING`
-   `LLVM_PROFDATA_FILE:PATH`
-   `LLVM_REVERSE_ITERATION:BOOL`
-   `LLVM_STATIC_LINK_CXX_STDLIB:BOOL`
-   `LLVM_TABLEGEN:STRING`
-   `LLVM_TARGET_ARCH:STRING`
-   `LLVM_TARGETS_TO_BUILD:STRING`
-   `LLVM_TEMPORARILY_ALLOW_OLD_TOOLCHAIN:BOOL`
-   `LLVM_UBSAN_FLAGS:STRING`
-   `LLVM_USE_CRT_{target}:STRING`
-   `LLVM_USE_INTEL_JITEVENTS:BOOL`
-   `LLVM_USE_LINKER:STRING`
-   `LLVM_USE_NEWPM:BOOL`
-   `LLVM_USE_OPROFILE:BOOL`
-   `LLVM_USE_PERF:BOOL`
-   `LLVM_USE_RELATIVE_PATHS_IN_FILES:BOOL`
-   `LLVM_USE_RELATIVE_PATHS_IN_DEBUG_INFO:BOOL`
-   `LLVM_USE_SANITIZER:STRING`
-   `LLVM_USE_SPLIT_DWARF:BOOL`
-   `SPHINX_EXECUTABLE:STRING`
-   `SPHINX_OUTPUT_HTML:BOOL`
-   `SPHINX_OUTPUT_MAN:BOOL`
-   `SPHINX_WARNINGS_AS_ERRORS:BOOL`
-   `LLVM_TOOLS_INSTALL_DIR:STRING`
-   `LLVM_UTILS_INSTALL_DIR:STRING`
-   `LLVM_EXAMPLES_INSTALL_DIR:STRING`